<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESL Quiz Game</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #teacherView, #studentView { display: none; }
    .choice { padding: 10px; margin: 5px; border: 1px solid #ccc; cursor: pointer; display: inline-block; }
    .choice:hover { background: #eee; }
    .choice:disabled { background: #ddd; cursor: default; }
  </style>
</head>
<body>
<h1>ESL Quiz Game</h1>

<div id="lobby">
  <p>Are you the teacher host or a student?</p>
  <button id="teacherBtn">Teacher</button>
  <button id="studentBtn">Student</button>
</div>

<div id="teacherView">
  <h2>Teacher Screen</h2>
  <button id="startBtn">Start Game</button>
  <div id="questionArea"></div>
  <h3>Scoreboard</h3>
  <ul id="scoreboard"></ul>
  <div id="teacherResults"></div>
</div>

<div id="studentView">
  <h2 id="studentName"></h2>
  <div id="questionAreaStudent"></div>
  <div id="studentResults"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, update, get, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// --- Your Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyAwCGVcbFrNIcRtbltP8ENl4Z77IsmzoSo",
  authDomain: "esl-quiz.firebaseapp.com",
  databaseURL: "https://esl-quiz-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esl-quiz",
  storageBucket: "esl-quiz.firebasestorage.app",
  messagingSenderId: "999634500142",
  appId: "1:999634500142:web:17b206cfaa5a2f6212bdbf"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- Global variables ---
let role = null;
let playerName = null;
let playerId = null;
let currentQuestionIndex = null;
let questionAnswered = false;

// --- Role selection ---
document.getElementById("teacherBtn").addEventListener("click", () => setRole("teacher"));
document.getElementById("studentBtn").addEventListener("click", () => setRole("student"));

function setRole(r) {
  role = r;
  document.getElementById("lobby").style.display = "none";
  if (role === "teacher") {
    document.getElementById("teacherView").style.display = "block";
    setupTeacher();
  } else {
    document.getElementById("studentView").style.display = "block";
    setupStudent();
  }
}

// --- Teacher setup ---
function setupTeacher() {
  const questions = [
    { text: "What is the past tense of 'go'?", choices: ["goed", "went", "goes", "going"], correct: 1 },
    { text: "What is the past tense of 'eat'?", choices: ["ate", "eated", "eaten", "eat"], correct: 0 },
    { text: "What is the past tense of 'drink'?", choices: ["drink", "drunk", "drank", "run"], correct: 2 }
  ];
  set(ref(db, "game1/questions"), questions);
  set(ref(db, "game1/state"), "lobby");
  set(ref(db, "game1/scores"), {});

  document.getElementById("startBtn").addEventListener("click", () => {
    update(ref(db, "game1"), { state: "quiz", currentQuestion: 0 });
  });

  onValue(ref(db, "game1"), (snap) => {
    const data = snap.val();
    if (!data) return;

    // Render scoreboard
    if (data.scores) {
      const html = Object.entries(data.scores).map(([name, score]) => `<li>${name}: ${score}</li>`).join("");
      document.getElementById("scoreboard").innerHTML = html;
    }

    // Show current question text
    if (data.state === "quiz") {
      const q = data.questions[data.currentQuestion];
      document.getElementById("questionArea").innerHTML = `<h3>${q.text}</h3>`;
    }

    // Show final winner
    if (data.state === "results") {
      const winner = getWinner(data.scores);
      document.getElementById("teacherResults").innerHTML = `<h2>üèÜ Winner: ${winner}</h2>`;
      document.getElementById("questionArea").innerHTML = "";
    }
  });
}

// --- Student setup ---
function setupStudent() {
  playerName = prompt("Enter your name:");
  playerId = Date.now();
  set(ref(db, `game1/players/${playerId}`), { name: playerName, score: 0 });
  document.getElementById("studentName").textContent = "Welcome, " + playerName;

  onValue(ref(db, "game1"), (snap) => {
    const data = snap.val();
    if (!data) return;

    if (data.state === "quiz" && data.currentQuestion !== currentQuestionIndex) {
      currentQuestionIndex = data.currentQuestion;
      questionAnswered = false;

      const q = data.questions[currentQuestionIndex];
      let html = `<h3>${q.text}</h3>`;
      q.choices.forEach((c, i) => {
        html += `<button class='choice' data-index='${i}'>${c}</button>`;
      });
      html += `<div id="feedback"></div>`;
      document.getElementById("questionAreaStudent").innerHTML = html;

      // Add click listeners
      document.querySelectorAll(".choice").forEach(btn => {
        btn.addEventListener("click", () => handleAnswer(i=btn.dataset.index, correctIndex=q.correct));
      });
    }

    // Show results
    if (data.state === "results") {
      const winner = getWinner(data.scores);
      document.getElementById("studentResults").innerHTML = `<h2>üèÜ Winner: ${winner}</h2>`;
      document.getElementById("questionAreaStudent").innerHTML = "";
    }
  });
}

// --- Student answer handler ---
function handleAnswer(i, correctIndex) {
  if (questionAnswered) return; // only allow one click per question
  questionAnswered = true;

  const choiceIndex = parseInt(i);
  const scoreRef = ref(db, `game1/scores/${playerName}`);
  const gameRef = ref(db, "game1");

  // Disable buttons
  document.querySelectorAll(".choice").forEach(btn => btn.disabled = true);

  // Show feedback
  document.getElementById("feedback").innerHTML =
    choiceIndex === correctIndex ? "‚úÖ Correct!" : "‚ùå Wrong!";

  // Update score safely
  runTransaction(scoreRef, current => (current || 0) + (choiceIndex === correctIndex ? 1 : 0));

  // Move to next question after delay
  setTimeout(() => {
    get(gameRef).then(snap => {
      const data = snap.val();
      const nextQ = currentQuestionIndex + 1;
      if (nextQ < data.questions.length) {
        // Advance to next question
        update(gameRef, { currentQuestion: nextQ });
        questionAnswered = false; // ‚úÖ allow answering again
      } else {
        // Quiz finished ‚Üí mark results and redirect
        update(gameRef, { state: "results" });
        endQuiz();
      }
    });
  }, 1500);
}

// --- End of quiz logic ---
function endQuiz() {
  document.getElementById("studentArea").innerHTML = "<h2>Quiz Finished!</h2>";

  setTimeout(() => {
    window.location.href = "minigame.html";
  }, 2000); // 2s delay before going to minigame
}


// --- Helper ---
function getWinner(scores) {
  if (!scores) return "No players";
  let max = -1, winner = "No one";
  for (const [name, score] of Object.entries(scores)) {
    if (score > max) {
      max = score;
      winner = name;
    }
  }
  return winner;
}

</script>
</body>
</html>
