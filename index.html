<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESL Quiz Prototype</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #teacherView, #studentView { display: none; }
    .choice { padding: 10px; margin: 5px; border: 1px solid #ccc; cursor: pointer; }
    .choice:hover { background: #eee; }
  </style>
</head>
<body>
  <h1>ESL Quiz Game (Prototype)</h1>

  <!-- Lobby -->
  <div id="lobby">
    <p>Are you the teacher host or a student?</p>
    <button onclick="setRole('teacher')">Teacher Host</button>
    <button onclick="setRole('student')">Student</button>
  </div>

  <!-- Teacher Screen -->
  <div id="teacherView">
    <h2>Teacher Host Screen</h2>
    <button onclick="startGame()">Start Game</button>
    <div id="questionArea"></div>
    <h3>Scoreboard</h3>
    <ul id="scoreboard"></ul>
  </div>

  <!-- Student Screen -->
  <div id="studentView">
    <h2 id="studentName"></h2>
    <div id="questionAreaStudent"></div>
  </div>

  <!-- Firebase -->
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ðŸ”¥ Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAwCGVcbFrNIcRtbltP8ENl4Z77IsmzoSo",
      authDomain: "esl-quiz.firebaseapp.com",
      databaseURL: "https://esl-quiz-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "esl-quiz",
      storageBucket: "esl-quiz.firebasestorage.app",
      messagingSenderId: "999634500142",
      appId: "1:999634500142:web:17b206cfaa5a2f6212bdbf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let role = null;
    let playerId = null;
    let playerName = null;
    let gameRef = ref(db, "game1"); // single game for now

    // ðŸ”¹ Choose role
    window.setRole = async function(r) {
      role = r;
      document.getElementById("lobby").style.display = "none";
      if (role === "teacher") {
        document.getElementById("teacherView").style.display = "block";
        setupTeacher();
      } else {
        document.getElementById("studentView").style.display = "block";
        setupStudent();
      }
    }

    // ðŸ”¹ Teacher setup
    function setupTeacher() {
      // Sample question set
      const questions = [
        { text: "What is the past tense of 'go'?", choices: ["goed", "went", "goes", "going"], correct: 1 }
        { text: "What is the past tense of 'eat'?", choices: ["ate", "eated", "eaten", "eat"], correct: 0 }
        { text: "What is the past tense of 'drink'?", choices: ["drink", "drunk", "drank", "run"], correct: 2 }
      ];
      set(ref(db, "game1/questions"), questions);
      set(ref(db, "game1/state"), "lobby");
    }

    // ðŸ”¹ Teacher starts game
    window.startGame = function() {
      update(ref(db, "game1"), { state: "quiz", currentQuestion: 0, scores: {} });
      loadTeacherView();
    }

    // ðŸ”¹ Teacher view logic
    function loadTeacherView() {
      onValue(ref(db, "game1"), (snap) => {
        const data = snap.val();
        if (!data) return;

        // Show question
        if (data.state === "quiz") {
          const q = data.questions[data.currentQuestion];
          document.getElementById("questionArea").innerHTML =
            `<h3>${q.text}</h3>
             <ul>${q.choices.map(c => `<li>${c}</li>`).join("")}</ul>`;
        }

        // Show scores
        if (data.scores) {
          let html = "";
          for (let [name, score] of Object.entries(data.scores)) {
            html += `<li>${name}: ${score}</li>`;
          }
          document.getElementById("scoreboard").innerHTML = html;
        }
      });
    }

    // ðŸ”¹ Student setup
    function setupStudent() {
      playerName = prompt("Enter your name:");
      playerId = Date.now();
      set(ref(db, `game1/players/${playerId}`), { name: playerName, score: 0 });
      document.getElementById("studentName").textContent = "Welcome, " + playerName;

      onValue(ref(db, "game1"), (snap) => {
        const data = snap.val();
        if (!data) return;

        if (data.state === "quiz") {
          const q = data.questions[data.currentQuestion];
          document.getElementById("questionAreaStudent").innerHTML =
            `<h3>${q.text}</h3>` +
            q.choices.map((c, i) => `<div class='choice' onclick='answer(${i})'>${c}</div>`).join("");
        }
      });
    }

    // ðŸ”¹ Student answers
    window.answer = function(choiceIndex) {
      get(ref(db, "game1")).then(snap => {
        const data = snap.val();
        const q = data.questions[data.currentQuestion];
        let score = 0;
        if (choiceIndex === q.correct) {
          score = 1;
        }
        update(ref(db, `game1/scores/${playerName}`), (oldScore) => (oldScore || 0) + score);
      });
    }
  </script>
</body>
</html>
