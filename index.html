<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ESL Quiz Game (Fixed)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #teacherView, #studentView { display: none; }
    .choice { padding: 10px; margin: 5px; border: 1px solid #ccc; cursor: pointer; display: inline-block; }
    .choice:hover { background: #eee; }
    .choice[disabled] { background: #ddd; cursor: default; }
  </style>
</head>
<body>
  <h1>ESL Quiz Game (Fixed)</h1>

  <div id="lobby">
    <p>Are you the teacher host or a student?</p>
    <button id="teacherBtn">Teacher Host</button>
    <button id="studentBtn">Student</button>
  </div>

  <div id="teacherView">
    <h2>Teacher Host Screen</h2>
    <button id="startBtn">Start Game</button>
    <div id="questionArea"></div>
    <h3>Scoreboard</h3>
    <ul id="scoreboard"></ul>
    <div id="teacherResults"></div>
  </div>

  <div id="studentView">
    <h2 id="studentName"></h2>
    <div id="questionAreaStudent"></div>
    <div id="studentResults"></div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, get, update, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // Your Firebase config here
  const firebaseConfig = {
    apiKey: "AIzaSyAwCGVcbFrNIcRtbltP8ENl4Z77IsmzoSo",
    authDomain: "esl-quiz.firebaseapp.com",
    databaseURL: "https://esl-quiz-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "esl-quiz",
    storageBucket: "esl-quiz.firebasestorage.app",
    messagingSenderId: "999634500142",
    appId: "1:999634500142:web:17b206cfaa5a2f6212bdbf"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let playerName = ""; // set when student joins
  let currentQuestionIndex = 0;
  let questionAnswered = false;

  // Called when a student selects an answer
  async function handleAnswer(choiceIndex, correctIndex) {
    if (questionAnswered) return; // prevent double clicks
    questionAnswered = true;

    const scoreRef = ref(db, `game1/scores/${playerName}`);
    const gameRef = ref(db, "game1");

    // Disable all buttons
    document.querySelectorAll(".choice").forEach(btn => btn.disabled = true);

    // Feedback
    document.getElementById("feedback").innerHTML =
      choiceIndex === correctIndex ? "✅ Correct!" : "❌ Wrong!";

    // Update score
    await runTransaction(scoreRef, current => {
      return (current || 0) + (choiceIndex === correctIndex ? 1 : 0);
    });

    // Delay, then move to next question or finish
    setTimeout(async () => {
      const snap = await get(gameRef);
      const data = snap.val();
      const nextQ = currentQuestionIndex + 1;

      if (nextQ < data.questions.length) {
        // go to next question
        await update(gameRef, { currentQuestion: nextQ });
        currentQuestionIndex = nextQ;
        questionAnswered = false;
        loadQuestion(nextQ, data.questions[nextQ]); // re-render
      } else {
        // quiz finished → set state and redirect
        await update(gameRef, { state: "results" });
        window.location.href = "minigame.html";
      }
    }, 1500);
  }

  // Example: render question and attach listeners
  function loadQuestion(qIndex, question) {
    const container = document.getElementById("questionContainer");
    container.innerHTML = `
      <h3>${question.text}</h3>
      <div>
        ${question.choices
          .map(
            (choice, i) =>
              `<button class="choice" onclick="handleAnswer(${i}, ${question.correct})">${choice}</button>`
          )
          .join("")}
      </div>
      <p id="feedback"></p>
    `;
    questionAnswered = false;
  }

  // Expose for inline onclick
  window.handleAnswer = handleAnswer;
</script>

</body>
</html>
